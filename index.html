<!DOCTYPE html>
<html>
  <body>
    <script>
window.onload = function() {
    var canvas, context, hiddenCanvas, hiddenContext, imagedata, data;
    var i, pc, ram = [], sp, stack = [], v = [];
    var key = [], keyPressed = false;
    var halt;
    var dt;

    // 123C 1234
    // 456D QWER
    // 789E ASDF
    // A0BF ZXCV
    var qwertyKeypad = {
        '88': 0,
        '49': 1,
        '50': 2,
        '51': 3,
        '81': 4,
        '87': 5,
        '69': 6,
        '65': 7,
        '83': 8,
        '68': 9,
        '90': 10,
        '67': 11,
        '52': 12,
        '82': 13,
        '70': 14,
        '86': 15
    };
    var keypad = qwertyKeypad;

    for (var n = 0; n < 4096; ++n) {
        ram[n] = 0;
    }

    var reset = function() {
        i = 0;
        pc = 0x0200;
        sp = 12;

        dt = 0;

        for (n = 0; n < 16; ++n) {
            v[n] = 0;
        }

        for (n = 0; n < 12; ++n) {
            stack[n] = 0;
        }

        for (n = 0; n < 16; ++n) {
            key[n] = false;
        }

        halt = true;

        hiddenContext.fillStyle = '#000';
        hiddenContext.fillRect(0, 0, hiddenCanvas.width, hiddenCanvas.height);
        imagedata = hiddenContext.getImageData(0, 0, hiddenCanvas.width,
          hiddenCanvas.height);
        data = imagedata.data;

        context.drawImage(hiddenCanvas, 0, 0, hiddenCanvas.width,
          hiddenCanvas.height, 0, 0, canvas.width, canvas.height);

        // font
        ram[0x0110] = 0xf0;
        ram[0x0111] = 0x80;
        ram[0x0112] = 0xf0;
        ram[0x0113] = 0x80;
        ram[0x0114] = 0xf0;
        ram[0x0115] = 0x80;
        ram[0x0116] = 0x80;
        ram[0x0117] = 0x80;
        ram[0x0118] = 0xf0;
        ram[0x0119] = 0x50;
        ram[0x011a] = 0x70;
        ram[0x011b] = 0x50;
        ram[0x011c] = 0xf0;
        ram[0x011d] = 0x50;
        ram[0x011e] = 0x50;
        ram[0x011f] = 0x50;
        ram[0x0120] = 0xf0;
        ram[0x0121] = 0x80;
        ram[0x0122] = 0xf0;
        ram[0x0123] = 0x10;
        ram[0x0124] = 0xf0;
        ram[0x0125] = 0x80;
        ram[0x0126] = 0xf0;
        ram[0x0127] = 0x90;
        ram[0x0128] = 0xf0;
        ram[0x0129] = 0x90;
        ram[0x012a] = 0xf0;
        ram[0x012b] = 0x10;
        ram[0x012c] = 0xf0;
        ram[0x012d] = 0x10;
        ram[0x012e] = 0xf0;
        ram[0x012f] = 0x90;
        ram[0x0130] = 0xf0;
        ram[0x0131] = 0x90;
        ram[0x0132] = 0x90;
        ram[0x0133] = 0x90;
        ram[0x0134] = 0xf0;
        ram[0x0135] = 0x10;
        ram[0x0136] = 0x10;
        ram[0x0137] = 0x10;
        ram[0x0138] = 0x10;
        ram[0x0139] = 0x60;
        ram[0x013a] = 0x20;
        ram[0x013b] = 0x20;
        ram[0x013c] = 0x20;
        ram[0x013d] = 0x70;
        ram[0x013e] = 0xa0;
        ram[0x013f] = 0xa0;
        ram[0x0140] = 0xf0;
        ram[0x0141] = 0x20;
        ram[0x0142] = 0x20;

        update(peek());
    };

    var disassemble = function(instruction) {
        var instructions = [
            function(instruction) {	// 0x00
                switch (instruction) {
                  case 0x00e0:
                    return 'CLS';
                  case 0x00ee:
                    return 'RET';
                  default:
                    return 'SYS #' + ('000' + (instruction & 0x0fff)
                      .toString(16)).slice(-3).toUpperCase();
                }
            },

            function(instruction) {	// 0x01
                var mmm = instruction & 0x0fff;
                return 'JP #' + ('000' + mmm.toString(16)).slice(-3)
                  .toUpperCase();
            },

            function(instruction) {	// 0x02
                var mmm = instruction & 0x0fff;
                return 'CALL #' + ('000' + mmm.toString(16)).slice(-3)
                  .toUpperCase();
            },

            function(instruction) {	// 0x03
                var x  = (instruction >>> 8) & 0x0f,
                    kk =  instruction        & 0xff;
                return 'SE V' + ('0' + x.toString(16)).slice(-1).toUpperCase() +
                  ',#' + ('00' + kk.toString(16)).slice(-2).toUpperCase();
            },

            function(instruction) {	// 0x04
                var x  = (instruction >>> 8) & 0x0f,
                    kk =  instruction        & 0xff;
                return 'SNE V' + ('0' + x.toString(16)).slice(-1)
                  .toUpperCase() + ',#' + ('00' + kk.toString(16)).slice(-2)
                  .toUpperCase();
            },

            function(instruction) {	// 0x05
                var x = (instruction >>> 8) & 0x0f,
                    y = (instruction >>> 4) & 0x0f;
                return 'SE V' + ('0' + x.toString(16)).slice(-1).toUpperCase() +
                  ',V' + ('0' + y.toString(16)).slice(-1).toUpperCase();
            },

            function(instruction) {	// 0x06
                var x  = (instruction >>> 8) & 0x0f,
                    kk =  instruction        & 0xff;
                return 'LD V' + ('0' + x.toString(16)).slice(-1).toUpperCase() +
                  ',#' + ('00' + kk.toString(16)).slice(-2).toUpperCase();
            },

            function(instruction) {	// 0x07
                var x  = (instruction >>> 8) & 0x0f,
                    kk =  instruction        & 0xff;
                return 'ADD V' + ('0' + x.toString(16)).slice(-1)
                  .toUpperCase() + ',#' + ('00' + kk.toString(16)).slice(-2)
                  .toUpperCase();
            },

            function(instruction) {	// 0x08
                var x = (instruction >>> 8) & 0x0f,
                    y = (instruction >>> 4) & 0x0f;

                switch (instruction & 0x0f) {
                  case 0x00:
                    return 'LD V' + ('0' + x.toString(16)).slice(-1)
                      .toUpperCase() + ',V' + ('0' + y.toString(16)).slice(-1)
                      .toUpperCase();
                  case 0x01:
                    return 'OR V' + ('0' + x.toString(16)).slice(-1)
                      .toUpperCase() + ',V' + ('0' + y.toString(16)).slice(-1)
                      .toUpperCase();
                  case 0x02:
                    return 'AND V' + ('0' + x.toString(16)).slice(-1)
                      .toUpperCase() + ',V' + ('0' + y.toString(16)).slice(-1)
                      .toUpperCase();
                  case 0x03:
                    return 'XOR V' + ('0' + x.toString(16)).slice(-1)
                      .toUpperCase() + ',V' + ('0' + y.toString(16)).slice(-1)
                      .toUpperCase();
                  case 0x04:
                    return 'ADD V' + ('0' + x.toString(16)).slice(-1)
                      .toUpperCase() + ',V' + ('0' + y.toString(16)).slice(-1)
                      .toUpperCase();
                  case 0x05:
                    return 'SUB V' + ('0' + x.toString(16)).slice(-1)
                      .toUpperCase() + ',V' + ('0' + y.toString(16)).slice(-1)
                      .toUpperCase();
                  case 0x06:
                    return 'SHR V' + ('0' + x.toString(16)).slice(-1)
                      .toUpperCase() + ',V' + ('0' + y.toString(16)).slice(-1)
                      .toUpperCase();
                  case 0x07:
                    return 'SUBN V' + ('0' + x.toString(16)).slice(-1)
                      .toUpperCase() + ',V' + ('0' + y.toString(16)).slice(-1)
                      .toUpperCase();
                  case 0x0e:
                    return 'SHL V' + ('0' + x.toString(16)).slice(-1)
                      .toUpperCase() + ',V' + ('0' + y.toString(16)).slice(-1)
                      .toUpperCase();
                  default:
                    return '...';
                }
            },

            function(instruction) {	// 0x09
                var x = (instruction >>> 8) & 0x0f,
                    y = (instruction >>> 4) & 0x0f;
                return 'SNE V' + ('0' + x.toString(16)).slice(-1)
                  .toUpperCase() + ',V' + ('0' + y.toString(16)).slice(-1)
                  .toUpperCase();
            },

            function(instruction) {	// 0x0a
                return 'LD I,#' + ('000' + (instruction & 0x0fff).toString(16))
                  .slice(-3).toUpperCase();
            },

            function(instruction) {	// 0x0b
                var mmm = instruction & 0x0fff;
                return 'JP V0,#' + ('000' + mmm.toString(16)).slice(-3)
                  .toUpperCase();
            },

            function(instruction) {	// 0x0c
                var x  = (instruction >>> 8) & 0x0f,
                    kk =  instruction        & 0xff;
                return 'RND V' + ('0' + x.toString(16)).slice(-1)
                  .toUpperCase() + ',#' + ('00' + kk.toString(16)).slice(-2)
                  .toUpperCase();;
            },

            function(instruction) {	// 0x0d
                var x = (instruction >>> 8) & 0x0f,
                    y = (instruction >>> 4) & 0x0f,
                    n =  instruction        & 0x0f;
                return 'DRW V' + ('0' + x.toString(16)).slice(-1)
                  .toUpperCase() + ',V' + ('0' + y.toString(16)).slice(-1)
                  .toUpperCase() + ',#' + ('0' + n.toString(16)).slice(-1)
                  .toUpperCase();
            },

            function(instruction) {	// 0x0e
                var x = (instruction >>> 8) & 0x0f;

                switch (instruction & 0xff) {
                  case 0x9e:
                    return 'SKP V' + ('0' + x.toString(16)).slice(-1)
                      .toUpperCase();
                  case 0xa1:
                    return 'SKNP V' + ('0' + x.toString(16)).slice(-1)
                      .toUpperCase();
                  default:
                    return '...';
                }
            },

            function(instruction) {	// 0x0f
                var x = (instruction >>> 8) & 0x0f;

                switch (instruction & 0xff) {
                  case 0x07:
                    return 'LD V' + ('0' + x.toString(16)).slice(-1)
                      .toUpperCase() + ',DT';
                  case 0x0a:
                    return 'LD V' + ('0' + x.toString(16)).slice(-1)
                      .toUpperCase() + ',K';
                  case 0x15:
                    return 'LD DT,V' + ('0' + x.toString(16)).slice(-1)
                      .toUpperCase();
                  case 0x18:
                    return 'LD ST,V' + ('0' + x.toString(16)).slice(-1)
                      .toUpperCase();
                  case 0x1e:
                    return 'ADD I,V' + ('0' + x.toString(16)).slice(-1)
                      .toUpperCase();
                  case 0x29:
                    return 'LD F,V' + ('0' + x.toString(16)).slice(-1)
                      .toUpperCase();
                  case 0x33:
                    return 'LD B,V' + ('0' + x.toString(16)).slice(-1)
                      .toUpperCase();
                  case 0x55:
                    return 'LD [I],V' + ('0' + x.toString(16)).slice(-1)
                      .toUpperCase();
                  case 0x65:
                    return 'LD V' + ('0' + x.toString(16)).slice(-1)
                      .toUpperCase() + ',[I]';
                  default:
                    return '...';
                }
            }
        ];

        return instructions[(instruction >>> 12) & 0x0f](instruction);
    };

    var execute = function(instruction) {
        var instructions = [
            function(instruction) {	// 0x00
                switch (instruction) {
                  case 0x00e0:
                    // 00E0 Erase display (all 0's)
                    hiddenContext.fillStyle = '#000';
                    hiddenContext.fillRect(0, 0, hiddenCanvas.width,
                      hiddenCanvas.height);
                    imagedata = hiddenContext.getImageData(0, 0,
                      hiddenCanvas.width, hiddenCanvas.height);
                    data = imagedata.data;

                    context.drawImage(hiddenCanvas, 0, 0, hiddenCanvas.width,
                      hiddenCanvas.height, 0, 0, canvas.width, canvas.height);
                    break;
                  case 0x00ee:
                    // 00EE Return from subroutine
                    pc = stack[sp++];
                    break;
                  default:
                    // 0MMM Do machine language subroutine at 0MMM
                    halt = true;	// N/A
                    break;
                }
            },

            function(instruction) {	// 0x01
                // 1MMM Go to 0MMM
                var mmm = instruction & 0x0fff;
                if (mmm == pc - 2) {
                    halt = true;
                }
                pc = mmm;
            },

            function(instruction) {	// 0x02
                // 2MMM Do subroutine at 0MMM
                var mmm = instruction & 0x0fff;
                stack[--sp] = pc;
                pc = mmm;
            },

            function(instruction) {	// 0x03
                // 3XKK Skip next instruction if VX = KK
                var x  = (instruction >>> 8) & 0x0f,
                    kk =  instruction        & 0xff;
                if (v[x] == kk) {
                    pc += 2;
                }
            },

            function(instruction) {	// 0x04
                // 4XKK Skip next instruction if VX n.e. KK
                var x  = (instruction >>> 8) & 0x0f,
                    kk =  instruction        & 0xff;
                if (v[x] != kk) {
                    pc += 2;
                }
            },

            function(instruction) {	// 0x05
                // 5XY0 Skip next instruction if VX = VY
                var x = (instruction >>> 8) & 0x0f,
                    y = (instruction >>> 4) & 0x0f;
                if (v[x] == v[y]) {
                    pc += 2;
                }
            },

            function(instruction) {	// 0x06
                // 6XKK Let VX = KK
                var x  = (instruction >>> 8) & 0x0f,
                    kk =  instruction        & 0xff;
                v[x] = kk;
            },

            function(instruction) {	// 0x07
                // 7XKK Let VX = VX + KK
                var x  = (instruction >>> 8) & 0x0f,
                    kk =  instruction        & 0xff;
                v[x] = (v[x] + kk) & 0xff;
            },

            function(instruction) {	// 0x08
                var x = (instruction >>> 8) & 0x0f,
                    y = (instruction >>> 4) & 0x0f;

                switch (instruction & 0x0f) {
                  case 0x00:
                    // 8XY0 Let VX = VY
                    v[x] = v[y];
                    break;
                  case 0x01:
                    // 8XY1 Let VX = VX | VY (VF changed)
                    v[x] |= v[y];
                    break;
                  case 0x02:
                    // 8XY2 Let VX = VX & VY (VF changed)
                    v[x] &= v[y];
                    break;
                  case 0x03:
                    // 8XY3 Let VX = VX ^ VY (VF changed)
                    v[x] ^= v[y];
                    break;
                  case 0x04:
                    // 8XY4 Let VX = VX + VY (VF = 00 if VX + VY l.e. FF,
                    //   VF = 01 if VX + VY > FF)
                    v[0x0f] = (v[x] + v[y] <= 0xff) ? (0) : (1);
                    v[x] = (v[x] + v[y]) & 0xff;
                    break;
                  case 0x05:
                    // 8XY5 Let VX = VX - VY (VF = 00 if VX < VY,
                    //   VF = 01 if VX - VY g.e. VY)
                    v[0x0f] = (v[x] < v[y]) ? (0) : (1);
                    v[x] = (v[x] - v[y]) & 0xff;
                    break;
                  case 0x06:
                    // 8XY6 Let VX = VY >>> 1 (VF = LSB of VY prior to SHR)
                    v[0x0f] = v[y] & 0x01;
                    v[x] = (v[y] >>> 1);
                    break;
                  case 0x07:
                    // 8XY7 Let VX = VY - VX (VF = 00 if VX < VY,
                    //   VF = 01 if VX - VY g.e. VY)
                    v[0x0f] = (v[y] < v[x]) ? (0) : (1);
                    v[x] = (v[y] - v[x]) & 0xff;
                    break;
                  case 0x0e:
                    // 8XYE Let VX = VY << 1 (VF = MSB of VY prior to SHL)
                    v[0x0f] = (v[y] & 0x80) ? (1) : (0);
                    v[x] = (v[y] << 1) & 0xff;
                    break;
                  default:
                    console.log('Invalid instruction: ' +
                      ('0000' + instruction.toString(16)).slice(-4)
                      .toUpperCase());
                    break;
                }
            },

            function(instruction) {	// 0x09
                // 9XY0 Skip next instruction if VX n.e. VY
                var x = (instruction >>> 8) & 0x0f,
                    y = (instruction >>> 4) & 0x0f;
                if (v[x] != v[y]) {
                    pc += 2;
                }
            },

            function(instruction) {	// 0x0a
                // AMMM Let I = 0MMM
                i = instruction & 0x0fff;
            },

            function(instruction) {	// 0x0b
                // BMMM Go to 0MMM + V0
                pc = ((instruction & 0x0fff) + v[0]) & 0x0fff;
            },

            function(instruction) {	// 0x0c
                // CXKK Let VX = Random Byte (KK = Mask)
                var x  = (instruction >>> 8) & 0x0f,
                    kk =  instruction        & 0xff;
                v[x] = (Math.random() * 255 | 0) & kk;
console.log(v[x]);
            },

            function(instruction) {	// 0x0d
                // DXYN Show n-byte MI pattern at VX-VY coordinates
                //   I unchanged. MI pattern is combined with existing display
                //   via EXCLUSIVE-OR function.
                //   VF = 01 if a 1 in MI pattern matches 1 in existing display.
                var x = (instruction >>> 8) & 0x0f,
                    y = (instruction >>> 4) & 0x0f,
                    n =  instruction        & 0x0f;

                if (v[x] < 0 || v[x] > 63 || v[y] < 0 || v[y] > 31) {
                    return;	// XXX
                }

                v[0x0f] = 0;

                for (var y2 = 0; y2 < n; ++y2) {
                    var bitmap = ram[i + y2];

                    for (var x2 = 0; x2 < 8; ++x2) {
                        if (bitmap & (0x80 >>> x2)) {
                            var index = ((v[y] + y2) * hiddenCanvas.width +
                              (v[x] + x2) & 0x07ff) << 2;

                            if (data[index] != 0 || data[index + 1] != 0 ||
                              data[index + 2] != 0 || data[index + 3] != 0xff) {
                                v[0x0f] = 1;
                            }

                            data[index    ] ^= 0xff;
                            data[index + 1] ^= 0xff;
                            data[index + 2] ^= 0xff;
                            data[index + 3]  = 0xff;
                        }
                    }
                }

                hiddenContext.putImageData(imagedata, 0, 0);

                context.drawImage(hiddenCanvas, 0, 0, hiddenCanvas.width,
                  hiddenCanvas.height, 0, 0, canvas.width, canvas.height);
            },

            function(instruction) {	// 0x0e
                var x = (instruction >>> 8) & 0x0f;

                switch (instruction & 0xff) {
                  case 0x9e:
                    // EX9E Skip next instruction if VX = Hex key (LSD)
                    if (key[v[x] & 0x0f]) {
                        pc += 2;
                    }
                    break;
                  case 0xa1:
                    // EXA1 Skip next instruction if VX n.e. Hex key (LSD)
                    if ( !key[v[x] & 0x0f]) {
                        pc += 2;
                    }
                    break;
                  default:
                    console.log('Invalid instruction: ' +
                      ('0000' + instruction.toString(16)).slice(-4)
                      .toUpperCase());
                    break;
                }
            },

            function(instruction) {	// 0x0f
                var x = (instruction >>> 8) & 0x0f;

                switch (instruction & 0xff) {
                  case 0x07:
                    // FX07 Let VX = current timer value
                    v[x] = dt;
                    break;
                  case 0x0a:
                    // FX0A Let VX = hex key digit (waits for any key pressed)
                    if (keyPressed === false) {
                        pc -= 2;
                    } else {
                        v[x] = keyPressed;
                        keyPressed = false;
                    }
                    break;
                  case 0x15:
                    // FX15 Set timer = VX (01 = 1/60 second)
                    dt = v[x];
                    break;
                  case 0x18:
                    // FX18 Set tone duration = VX (01 = 1/60 second)
                    var oscillator = audioContext.createOscillator();
                    oscillator.type = 0;
                    oscillator.frequency.value = 400;
                    oscillator.connect(audioContext.destination);
                    oscillator.noteOn(0);
                    oscillator.noteOff(audioContext.currentTime +
                        (1 / 60 * v[x]));
                    break;
                  case 0x1e:
                    // FX1E Let I = I + VX
                    i = (i + v[x]) & 0x0fff;
                    break;
                  case 0x29:
                    // FX29 Let I = 5-byte display pattern for LSD of VX
                    var xlat = [
                      0x0130, 0x0139, 0x0122, 0x012a,
                      0x013e, 0x0120, 0x0124, 0x0134,
                      0x0126, 0x0128, 0x012e, 0x0118,
                      0x0114, 0x011c, 0x0110, 0x0112
                    ];
                    i = xlat[v[x] & 0x0f];
                    break;
                  case 0x33:
                    // FX33 Let MI = 3-decimal digit equivalent of VX
                    //   (I unchanged)
                    ram[i    ] = Math.floor(v[x] / 100);
                    ram[i + 1] = Math.floor(v[x] / 10) % 10;
                    ram[i + 2] = (v[x] % 100) % 10;
                    break;
                  case 0x55:
                    // FX55 Let MI = V0:VX (I = I + X + 1)
                    for (var n = 0; n <= x; ++n) {
                        ram[(i + n) & 0x07ff] = v[n];
                    }
                    i += x + 1;
                    break;
                  case 0x65:
                    // FX65 Let V0: VX MI (I = I + X + 1)
                    for (n = 0; n <= x; ++n) {
                        v[n] = ram[(i + n) & 0x07ff];
                    }
                    i += x + 1;
                    break;
                  default:
                    console.log('Invalid instruction: ' +
                      ('0000' + instruction.toString(16)).slice(-4)
                      .toUpperCase());
                    break;
                }
            }
        ];

        instructions[(instruction >>> 12) & 0x0f](instruction);
    };

    var fetch = function() {
        var instruction = peek();
        pc += 2;
        return instruction;
    };

    var peek = function() {
        var hi = ram[pc    ] & 0xff,
            lo = ram[pc + 1] & 0xff;
        return (hi << 8) | lo;
    };

    var timeout;
    var go = function() {
        var tick = 0;

        if ( !halt) {
//            while (tick++ < 1) {
            while (tick++ < 13 /* ~COSMAC VIP */) {
//            while (tick++ < 97) {
//            while (tick++ < 66653 /* 4MHz */) {
                execute(fetch());
            }
            update(peek());

            if (dt > 0) {
                --dt;
            }

            timeout = window.setTimeout(go, 1000 / 60);
        }
    };

    var trace = function() {
        if ( !halt) {
            execute(fetch());
            update(peek());
        }
    };

    var update = function(instruction) {
        var td = document.getElementById('instruction');
        td.innerHTML = ('0000' + instruction.toString(16)).slice(-4)
          .toUpperCase();

        td = document.getElementById('mnemonic');
        td.innerHTML = disassemble(instruction);

        td = document.getElementById('pc');
        td.innerHTML = ('0000' + pc.toString(16)).slice(-4).toUpperCase();

        td = document.getElementById('i');
        td.innerHTML = ('0000' + i.toString(16)).slice(-4).toUpperCase();

        td = document.getElementById('sp');
        td.innerHTML = ('00' + sp.toString(16)).slice(-2).toUpperCase();

        for (var n = 0; n < 16; ++n) {
            td = document.getElementById('v' + n.toString(16));
            td.innerHTML = ('00' + v[n].toString(16)).slice(-2).toUpperCase() +
              ' (' + ('___' + v[n]).slice(-3) + ')';
        }
    };

    document.title = 'HTML5 CHIP-8 Interpreter';

    canvas = document.createElement('canvas');

    canvas.width  = 64 * 10;
    canvas.height = 32 * 10;

    context = canvas.getContext('2d');

    context.imageSmoothingEnabled         =
      context.mozImageSmoothingEnabled    =
      context.msImageSmoothingEnabled     =
      context.webkitImageSmoothingEnabled = false;

    document.body.appendChild(canvas);

    hiddenCanvas = document.createElement('canvas');

    hiddenCanvas.width  = 64;
    hiddenCanvas.height = 32;

    hiddenContext = hiddenCanvas.getContext('2d');

    var audioContext = new webkitAudioContext();

    var input = document.createElement('input');
    input.type = 'file';
    input.style.display = 'block';

    input.addEventListener('change', function(e) {
        var files = e.target.files;

        if (files.length == 1) {
            var reader = new FileReader();

            reader.onload = function(e) {
                var array = new Uint8Array(e.target.result);

                for (n = 0; n < array.length; ++n) {
                    ram[0x0200 + n] = array[n];
                }
                reset();
            };

            reader.readAsArrayBuffer(files[0]);
        }
    }, false);

    document.body.appendChild(input);

    var table = document.createElement('table');
    table.style.fontFamily = 'monospace';
    var tbody = document.createElement('tbody');

////
    var tr = document.createElement('tr');

    var td = document.createElement('td');

    td.appendChild(document.createTextNode('Instr.'));
    tr.appendChild(td);

    td = document.createElement('td');
    td.id = 'instruction';
    td.style.textAlign = 'right';
    td.style.width = '128px';

    td.appendChild(document.createTextNode(''));
    tr.appendChild(td);

    tbody.appendChild(tr);

////
    var tr = document.createElement('tr');

    var td = document.createElement('td');

    td.appendChild(document.createTextNode(''));
    tr.appendChild(td);

    td = document.createElement('td');
    td.id = 'mnemonic';
    td.style.textAlign = 'right';
    td.style.width = '128px';

    td.appendChild(document.createTextNode(''));
    tr.appendChild(td);

    tbody.appendChild(tr);

////
    tr = document.createElement('tr');

    td = document.createElement('td');

    td.appendChild(document.createTextNode('PC'));
    tr.appendChild(td);

    td = document.createElement('td');
    td.id = 'pc';
    td.style.textAlign = 'right';
    td.style.width = '128px';

    td.appendChild(document.createTextNode(''));
    tr.appendChild(td);

    tbody.appendChild(tr);

////
    tr = document.createElement('tr');

    td = document.createElement('td');

    td.appendChild(document.createTextNode('I'));
    tr.appendChild(td);

    td = document.createElement('td');
    td.id = 'i';
    td.style.textAlign = 'right';

    td.appendChild(document.createTextNode(''));
    tr.appendChild(td);

    tbody.appendChild(tr);

////
    tr = document.createElement('tr');

    td = document.createElement('td');

    td.appendChild(document.createTextNode('SP'));
    tr.appendChild(td);

    td = document.createElement('td');
    td.id = 'sp';
    td.style.textAlign = 'right';

    td.appendChild(document.createTextNode(''));
    tr.appendChild(td);

    tbody.appendChild(tr);

////
    for (var n = 0; n < 16; ++n) {
        tr = document.createElement('tr');

        td = document.createElement('td');

        td.appendChild(document.createTextNode('V' + n.toString(16)
          .toUpperCase()));
        tr.appendChild(td);

        td = document.createElement('td');
        td.id = 'v' + n.toString(16);
        td.style.textAlign = 'right';

        td.appendChild(document.createTextNode(''));
        tr.appendChild(td);

        tbody.appendChild(tr);
    }

    table.appendChild(tbody);

    document.body.appendChild(table);

    document.addEventListener('keypress', function(e) {
        switch (e.which) {
          case 53:	// (5)eset
            if (typeof timeout !== 'undefined') {
                halt = true;
                window.clearTimeout(timeout);
                timeout = undefined;
            }
            reset();
            break;
          case 103:	// (g)o
            halt = false;
            go();
            break;
          case 116:	// (t)race
            if (typeof timeout !== 'undefined') {
                halt = true;
                window.clearTimeout(timeout);
                timeout = undefined;
            }
            halt = false;
            trace();
            break;
        }
    }, false);

    document.addEventListener('keydown', function(e) {
        if (e.which in keypad) {
            key[keypad[e.which]] = true;
        }
    }, false);

    document.addEventListener('keyup', function(e) {
        if (e.which in keypad) {
            key[keypad[e.which]] = false;
            keyPressed = keypad[e.which];
        }
    }, false);

    reset();
};
    </script>
  </body>
</html>
